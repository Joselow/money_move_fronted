name: deploy

on:
  workflow_run:
    workflows: [ "lint" ]        # debe coincidir con name: lint
    types: [ completed ]
  workflow_dispatch: {}

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: ubuntu-latest
    steps:

      - name: SSH deploy (pull + build)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            APP_DIR="${{ secrets.APP_DIR }}"
            NODE_VER="${{ secrets.NODE_VERSION }}"
            cd "$APP_DIR"
            git fetch --all --prune
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"
            export NVM_DIR="$HOME/.nvm"
            source ~/.nvm/nvm.sh
            npm install 
            npm run build
            echo "OK deploy ($BRANCH)"
            exit
